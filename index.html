<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Night Transmission</title>
  <style>
    :root{
      --bg:#07090d; --panel:#0d1118; --line:#1b2433;
      --text:#e8eefc; --muted:#93a4c7; --accent:#8cf0ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; display:grid; place-items:center;
      background:
        radial-gradient(900px 500px at 20% 20%, rgba(140,240,255,.10), transparent 55%),
        radial-gradient(900px 600px at 50% 90%, rgba(140,240,255,.06), transparent 60%),
        var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", sans-serif;
    }
    .wrap{width:min(760px, 92vw); padding:22px;}
    .card{
      background:rgba(255,255,255,.02);
      border:1px solid var(--line);
      border-radius:18px;
      padding:18px;
      box-shadow: 0 10px 40px rgba(0,0,0,.35);
    }
    header{display:flex; align-items:baseline; justify-content:space-between; gap:12px;}
    h1{margin:0; font-size:18px; font-weight:800; letter-spacing:.8px; text-transform:uppercase;}
    .jp{margin-top:4px; font-size:12px; color:var(--muted); font-weight:600;}
    .status{font-size:12px; color:var(--muted); display:flex; gap:10px; align-items:center;}
    .dot{width:8px;height:8px;border-radius:99px;background:rgba(147,164,199,.35);}
    .dot.on{background:var(--accent); box-shadow:0 0 18px rgba(140,240,255,.55);}
    .panel{margin-top:14px; padding:14px; border-radius:14px; border:1px solid rgba(27,36,51,.9); background:rgba(13,17,24,.72);}
    #pad{
      width:100%; height:220px; border-radius:16px;
      border:1px solid rgba(140,240,255,.25);
      background:rgba(10,14,20,.6);
      color:var(--text);
      font-size:26px; font-weight:800; letter-spacing:1px; text-transform:uppercase;
      user-select:none; -webkit-user-select:none; touch-action:none;
    }
    #pad:active{border-color: rgba(140,240,255,.55);}
    .sub{margin-top:10px; display:flex; justify-content:space-between; gap:10px; color:var(--muted); font-size:12px; line-height:1.6;}
    .row{display:flex; gap:10px; margin-top:12px;}
    .btn{flex:1; padding:12px 10px; border-radius:12px; border:1px solid rgba(147,164,199,.25);
      background:rgba(255,255,255,.03); color:var(--text); font-weight:800; font-size:12px; letter-spacing:.6px; text-transform:uppercase;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <header>
        <div>
          <h1>Night Transmission</h1>
          <div class="jp">夜の通信</div>
        </div>
        <div class="status">
          <div class="dot" id="dot"></div>
          <span class="mono" id="readout">IDLE</span>
        </div>
      </header>

      <div class="panel">
        <button id="pad" type="button">TRANSMIT</button>

        <div class="sub">
          <div>押してる間：FM-ish Busy Tone（ツーツー）</div>
          <div class="mono">each press: random</div>
        </div>

        <div class="row">
          <button class="btn" id="reroll" type="button">REROLL</button>
          <button class="btn" id="oneshot" type="button">ONE SHOT</button>
        </div>
      </div>
    </div>
  </div>

<script>
let ctx;
let master, gate, bp;
let carrier, mod, modGain;
let isHolding = false;
let timer = null;
let on = false;

const dot = document.getElementById("dot");
const readout = document.getElementById("readout");
const pad = document.getElementById("pad");
const rerollBtn = document.getElementById("reroll");
const oneshotBtn = document.getElementById("oneshot");

function ensureAudio(){
  if (ctx) return;
  ctx = new (window.AudioContext || window.webkitAudioContext)();

  master = ctx.createGain(); master.gain.value = 0.0;
  gate   = ctx.createGain(); gate.gain.value = 0.0;

  // “電話回線”っぽい帯域
  bp = ctx.createBiquadFilter();
  bp.type = "bandpass";
  bp.frequency.value = 1400;
  bp.Q.value = 0.9;

  carrier = ctx.createOscillator();
  mod     = ctx.createOscillator();
  carrier.type = "sine";
  mod.type = "sine";

  modGain = ctx.createGain();
  modGain.gain.value = 0;

  // FM: mod -> modGain -> carrier.frequency
  mod.connect(modGain);
  modGain.connect(carrier.frequency);

  carrier.connect(gate);
  gate.connect(bp);
  bp.connect(master);
  master.connect(ctx.destination);

  carrier.start();
  mod.start();
}

function ramp(param, value, t=0.02){
  const now = ctx.currentTime;
  param.cancelScheduledValues(now);
  param.setValueAtTime(param.value, now);
  param.linearRampToValueAtTime(value, now + t);
}

function setUI(active, text){
  dot.classList.toggle("on", !!active);
  readout.textContent = text;
}

function randomizeTimbre(){
  // Busy-tone系の芯（定番寄り）
  const base = (Math.random() < 0.5 ? 480 : 620);
  const carrierHz = Math.max(180, base + (Math.random()*80 - 40));

  // FM7っぽい“比率っぽさ”
  const ratios = [0.5, 1, 1.5, 2, 3, 4, 5, 6];
  const ratio = ratios[(Math.random()*ratios.length)|0] + (Math.random()*0.06 - 0.03);

  // 明るさ（変調の深さ）
  const index = 60 + Math.random()*260;

  carrier.frequency.value = carrierHz;
  mod.frequency.value = carrierHz * ratio;
  modGain.gain.value = index;

  // 回線感も軽く揺らす
  bp.frequency.value = 1100 + Math.random()*1100;
  bp.Q.value = 0.7 + Math.random()*0.7;

  setUI(isHolding, `FM ${ratio.toFixed(2)}  IDX ${Math.round(index)}  BP ${Math.round(bp.frequency.value)}Hz`);
}

// ツーツー：0.5s ON / 0.5s OFF
function startCadence(){
  if (timer) return;
  const onMs = 500, offMs = 500;
  on = false;

  const step = () => {
    if (!isHolding) return;
    on = !on;
    if (on){
      ramp(gate.gain, 1.0, 0.01);
      ramp(master.gain, 0.16, 0.015);
      setUI(true, readout.textContent);
      timer = setTimeout(step, onMs);
    } else {
      ramp(gate.gain, 0.0, 0.03);
      ramp(master.gain, 0.0, 0.05);
      setUI(false, readout.textContent);
      timer = setTimeout(step, offMs);
    }
  };
  step();
}

function stopCadence(){
  if (timer){ clearTimeout(timer); timer = null; }
  if (ctx){
    ramp(gate.gain, 0.0, 0.04);
    ramp(master.gain, 0.0, 0.06);
  }
  setUI(false, "IDLE");
}

function holdOn(){
  ensureAudio();
  ctx.resume();
  isHolding = true;
  randomizeTimbre();
  startCadence();
}

function holdOff(){
  isHolding = false;
  stopCadence();
}

function oneShot(){
  ensureAudio();
  ctx.resume();
  randomizeTimbre();
  const now = ctx.currentTime;

  gate.gain.cancelScheduledValues(now);
  master.gain.cancelScheduledValues(now);

  gate.gain.setValueAtTime(0.0, now);
  master.gain.setValueAtTime(0.0, now);

  gate.gain.linearRampToValueAtTime(1.0, now + 0.01);
  master.gain.linearRampToValueAtTime(0.16, now + 0.015);

  gate.gain.linearRampToValueAtTime(0.0, now + 0.22);
  master.gain.linearRampToValueAtTime(0.0, now + 0.28);

  setUI(true, readout.textContent);
  setTimeout(()=> setUI(false, "IDLE"), 350);
}

// Events (mouse + touch)
pad.addEventListener("mousedown", (e)=>{ e.preventDefault(); holdOn(); });
window.addEventListener("mouseup", ()=> holdOff());
pad.addEventListener("touchstart", (e)=>{ e.preventDefault(); holdOn(); }, {passive:false});
pad.addEventListener("touchend", (e)=>{ e.preventDefault(); holdOff(); }, {passive:false});
pad.addEventListener("touchcancel", (e)=>{ e.preventDefault(); holdOff(); }, {passive:false});

window.addEventListener("blur", ()=> holdOff());
document.addEventListener("visibilitychange", ()=>{ if (document.hidden) holdOff(); });

rerollBtn.addEventListener("click", ()=>{ ensureAudio(); ctx.resume(); randomizeTimbre(); });
oneshotBtn.addEventListener("click", ()=> oneShot());
</script>
</body>
</html>
